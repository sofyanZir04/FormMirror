<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Analytics with Credentials</title>
    <script>
        // Test the fetch with credentials
        async function testAnalytics() {
            try {
                const response = await fetch('/api/analytics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        pid: 'test-project',
                        sid: 'test-session',
                        events: [{
                            evt: 'test',
                            fld: 'test-field',
                            t: Date.now()
                        }]
                    }),
                    credentials: 'include'  // This is important for cross-origin requests
                });
                
                console.log('Response status:', response.status);
                if (response.ok) {
                    console.log('Analytics tracking successful');
                } else {
                    console.error('Analytics tracking failed:', response.status);
                }
            } catch (error) {
                console.error('Error sending analytics:', error);
            }
        }
        
        // Test the tracking script loading
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, testing analytics...');
            
            // Create a test form to verify tracking
            const form = document.createElement('form');
            form.id = 'test-form';
            form.innerHTML = `
                <input type="text" name="test-field" placeholder="Test field" />
                <input type="email" name="email" placeholder="Email" />
                <button type="submit">Submit</button>
            `;
            document.body.appendChild(form);
            
            // Load the tracking script
            const script = document.createElement('script');
            script.src = '/static/fm-core.js';
            script.setAttribute('data-project-id', 'test-project');
            script.async = true;
            document.head.appendChild(script);
            
            // Test manual tracking
            setTimeout(testAnalytics, 1000);
        });
    </script>
</head>
<body>
    <h1>Analytics Tracking Test</h1>
    <p>This page tests the analytics tracking with proper credentials and CORS handling.</p>
</body>
</html>